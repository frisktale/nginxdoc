import{r as p,c as o,a as n,b as e,F as r,e as s,d as t,o as c}from"./app.9c72f7b5.js";import{_ as l}from"./plugin-vue_export-helper.5a098b48.js";const i={},u=n("h1",{id:"\u4F7F\u7528-dtrace-pid-\u63D0\u4F9B\u7A0B\u5E8F\u8C03\u8BD5-nginx",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u4F7F\u7528-dtrace-pid-\u63D0\u4F9B\u7A0B\u5E8F\u8C03\u8BD5-nginx","aria-hidden":"true"},"#"),s(" \u4F7F\u7528 DTrace pid \u63D0\u4F9B\u7A0B\u5E8F\u8C03\u8BD5 nginx")],-1),d=s("\u672C\u6587\u5047\u8BBE\u8BFB\u8005\u5BF9 nginx \u5185\u90E8\u539F\u7406\u548C "),_={href:"http://nginx.org/en/docs/nginx_dtrace_pid_provider.html#see_also",target:"_blank",rel:"noopener noreferrer"},k=s("DTrace"),g=s(" \u6709\u4E86\u4E00\u5B9A\u7684\u4E86\u89E3\u3002"),h=s("\u867D\u7136\u4F7F\u7528\u4E86 "),b={href:"http://nginx.org/en/docs/debugging_log.html",target:"_blank",rel:"noopener noreferrer"},m=s("--with-debug"),x=s(" \u9009\u9879\u6784\u5EFA\u7684 nginx \u5DF2\u7ECF\u63D0\u4F9B\u4E86\u5927\u91CF\u5173\u4E8E\u8BF7\u6C42\u5904\u7406\u7684\u4FE1\u606F\uFF0C\u4F46\u6709\u65F6\u5019\u66F4\u6709\u5FC5\u8981\u8BE6\u7EC6\u5730\u8DDF\u8E2A\u4EE3\u7801\u8DEF\u5F84\u7684\u7279\u5B9A\u90E8\u5206\uFF0C\u540C\u65F6\u7701\u7565\u5176\u4F59\u4E0D\u5FC5\u8981\u7684\u8C03\u8BD5\u8F93\u51FA\u3002DTrace pid \u63D0\u4F9B\u7A0B\u5E8F\uFF08\u5728 Solaris\uFF0CMacOS \u4E0A\u53EF\u7528\uFF09\u662F\u4E00\u4E2A\u7528\u4E8E\u6D4F\u89C8\u7528\u6237\u7A0B\u5E8F\u5185\u90E8\u7684\u6709\u7528\u5DE5\u5177\uFF0C\u56E0\u4E3A\u5B83\u4E0D\u9700\u8981\u66F4\u6539\u4EFB\u4F55\u4EE3\u7801\uFF0C\u5C31\u53EF\u4EE5\u5E2E\u52A9\u60A8\u5B8C\u6210\u4EFB\u52A1\u3002\u8DDF\u8E2A\u548C\u6253\u5370 nginx \u51FD\u6570\u8C03\u7528\u7684\u7B80\u5355 DTrace \u811A\u672C\u793A\u4F8B\u5982\u4E0B\u6240\u793A\uFF1A"),f=t(`<div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code>#<span class="token keyword">pragma</span> D option flowindent

pid<span class="token keyword">$</span>target<span class="token punctuation">:</span>nginx<span class="token punctuation">:</span><span class="token punctuation">:</span>entry <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

pid<span class="token keyword">$</span>target<span class="token punctuation">:</span>nginx<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">return</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>\u5C3D\u7BA1\u5982\u6B64\uFF0CDTrace \u7684\u51FD\u6570\u8C03\u7528\u8DDF\u8E2A\u529F\u80FD\u4EC5\u63D0\u4F9B\u6709\u9650\u7684\u6709\u7528\u4FE1\u606F\u3002\u5B9E\u65F6\u68C0\u67E5\u7684\u529F\u80FD\u53C2\u6570\u901A\u5E38\u66F4\u52A0\u6709\u8DA3\uFF0C\u4F46\u4E5F\u66F4\u590D\u6742\u4E00\u4E9B\u3002\u4EE5\u4E0B\u793A\u4F8B\u65E8\u5728\u5E2E\u52A9\u8BFB\u8005\u719F\u6089 DTrace \u4EE5\u53CA\u4F7F\u7528 DTrace \u5206\u6790 nginx \u884C\u4E3A\u7684\u8FC7\u7A0B\u3002</p><p>\u4F7F\u7528 DTrace \u4E0E nginx \u7684\u5E38\u89C1\u65B9\u6848\u4E4B\u4E00\u662F\uFF1A\u9644\u52A0\u5230 nginx \u7684\u5DE5\u4F5C\u8FDB\u7A0B\u6765\u8BB0\u5F55\u8BF7\u6C42\u884C\u548C\u8BF7\u6C42\u5F00\u59CB\u65F6\u95F4\u3002\u9644\u52A0\u7684\u76F8\u5E94\u51FD\u6570\u662F <code>ngx_http_process_request()</code>\uFF0C\u53C2\u6570\u6307\u5411\u7684\u662F\u4E00\u4E2A <code>ngx_http_request_t</code> \u7ED3\u6784\u7684\u6307\u9488\u3002\u4F7F\u7528 DTrace \u811A\u672C\u5B9E\u73B0\u8FD9\u79CD\u8BF7\u6C42\u65E5\u5FD7\u8BB0\u5F55\u53EF\u4EE5\u7B80\u5355\u5230\uFF1A</p><div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code>pid<span class="token keyword">$</span>target<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span>ngx_http_process_request<span class="token punctuation">:</span>entry
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request <span class="token operator">=</span> <span class="token punctuation">(</span>ngx_http_request_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">copyin</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>ngx_http_request_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request_line <span class="token operator">=</span> <span class="token function">stringof</span><span class="token punctuation">(</span><span class="token function">copyin</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                                         <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;request line = %s\\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;request start sec = %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>start_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>\u9700\u8981\u6CE8\u610F\u7684\u662F\uFF0C\u5728\u4E0A\u9762\u7684\u793A\u4F8B\u4E2D\uFF0CDTrace \u9700\u8981\u5F15\u7528 <code>ngx_http_process_request</code> \u7ED3\u6784\u7684\u4E00\u4E9B\u76F8\u5173\u4FE1\u606F\u3002\u4E0D\u5E78\u7684\u662F\uFF0C\u867D\u7136\u53EF\u4EE5\u5728 DTrace \u811A\u672C\u4E2D\u4F7F\u7528\u7279\u5B9A\u7684 <code>#include</code> \u6307\u4EE4\uFF0C\u7136\u540E\u5C06\u5176\u4F20\u9012\u7ED9 C \u9884\u5904\u7406\u5668\uFF08\u4F7F\u7528 <code>-C</code> \u6807\u5FD7\uFF09\uFF0C\u4F46\u8FD9\u5E76\u4E0D\u80FD\u771F\u6B63\u8D77\u6548\u3002\u7531\u4E8E\u5927\u91CF\u7684\u4EA4\u53C9\u4F9D\u8D56\uFF0C\u51E0\u4E4E\u6240\u6709\u7684 nginx \u5934\u6587\u4EF6\u90FD\u5FC5\u987B\u5305\u542B\u5728\u5185\u3002\u53CD\u8FC7\u6765\uFF0C\u57FA\u4E8E <code>configure</code> \u811A\u672C\u8BBE\u7F6E\uFF0Cnginx \u5934\u5C06\u5305\u62EC PCRE\u3001OpenSSL \u548C\u5404\u79CD\u7CFB\u7EDF\u5934\u6587\u4EF6\u3002\u7406\u8BBA\u4E0A\uFF0C\u5728 DTrace \u811A\u672C\u9884\u5904\u7406\u548C\u7F16\u8BD1\u65F6\uFF0C\u4E0E\u7279\u5B9A\u7684 nginx \u6784\u5EFA\u76F8\u5173\u7684\u6240\u6709\u5934\u6587\u4EF6\u90FD\u6709\u53EF\u80FD\u88AB\u5305\u542B\u8FDB\u6765\uFF0C\u5B9E\u9645\u4E0A DTrace \u811A\u672C\u5F88\u6709\u53EF\u80FD\u7531\u4E8E\u67D0\u4E9B\u5934\u6587\u4EF6\u4E2D\u7684\u672A\u77E5\u8BED\u6CD5\u800C\u9020\u6210\u65E0\u6CD5\u7F16\u8BD1\u3002</p><p>\u4E0A\u8FF0\u95EE\u9898\u53EF\u4EE5\u901A\u8FC7\u5728 DTrace \u811A\u672C\u4E2D\u4EC5\u5305\u542B\u76F8\u5173\u4E14\u5FC5\u8981\u7684\u7ED3\u6784\u548C\u7C7B\u578B\u5B9A\u4E49\u6765\u89E3\u51B3\u3002DTrace \u5FC5\u987B\u77E5\u9053\u7ED3\u6784\u3001\u7C7B\u578B\u548C\u5B57\u6BB5\u504F\u79FB\u7684\u5927\u5C0F\u3002\u56E0\u6B64\uFF0C\u901A\u8FC7\u624B\u52A8\u4F18\u5316\u7528\u4E8E DTrace \u7684\u7ED3\u6784\u5B9A\u4E49\uFF0C\u53EF\u4EE5\u8FDB\u4E00\u6B65\u964D\u4F4E\u4F9D\u8D56\u3002</p><p>\u8BA9\u6211\u4EEC\u4F7F\u7528\u4E0A\u9762\u7684 DTrace \u811A\u672C\u793A\u4F8B\uFF0C\u770B\u770B\u5B83\u9700\u8981\u54EA\u4E9B\u7ED3\u6784\u5B9A\u4E49\u624D\u80FD\u6B63\u5E38\u5730\u5DE5\u4F5C\u3002</p><p>\u9996\u5148\u5E94\u8BE5\u5305\u542B\u7531 configure \u751F\u6210\u7684 <code>objs/ngx_auto_config.h</code> \u6587\u4EF6\uFF0C\u56E0\u4E3A\u5B83\u5B9A\u4E49\u4E86\u4E00\u4E9B\u5F71\u54CD\u5404\u4E2A\u65B9\u9762\u7684 <code>\uFF03ifdef</code> \u5E38\u91CF\u3002\u4E4B\u540E\uFF0C\u4E00\u4E9B\u57FA\u672C\u7C7B\u578B\u548C\u5B9A\u4E49\uFF08\u5982 <code>ngx_str_t</code>\uFF0C<code>ngx_table_elt_t</code>\uFF0C<code>ngx_uint_t</code> \u7B49\uFF09\u5E94\u653E\u5728 DTrace \u811A\u672C\u7684\u5F00\u5934\u3002\u8FD9\u4E9B\u5B9A\u4E49\u7ECF\u5E38\u88AB\u4F7F\u7528\u4F46\u4E0D\u592A\u53EF\u80FD\u7ECF\u5E38\u6539\u53D8\u7684\u3002</p><p>\u90A3\u91CC\u6709\u4E00\u4E2A\u5305\u542B\u8BB8\u591A\u6307\u5411\u5176\u4ED6\u7ED3\u6784\u7684\u6307\u9488\u7684 ngx_http_process_request_t \u7ED3\u6784\u3002\u56E0\u4E3A\u8FD9\u4E9B\u6307\u9488\u4E0E\u8FD9\u4E2A\u811A\u672C\u65E0\u5173\uFF0C\u800C\u4E14\u56E0\u4E3A\u5B83\u4EEC\u5177\u6709\u76F8\u540C\u7684\u5927\u5C0F\uFF0C\u6240\u4EE5\u53EF\u4EE5\u7528 void \u6307\u9488\u6765\u66FF\u6362\u5B83\u4EEC\u3002\u4F46\u6700\u597D\u6DFB\u52A0\u5408\u9002\u7684 typedef\uFF0C\u800C\u4E0D\u662F\u66F4\u6539\u5B9A\u4E49\uFF1A</p><div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code><span class="token keyword">typedef</span> ngx_http_upstream_t     <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> ngx_http_request_body_t <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u6700\u540E\u4F46\u540C\u6837\u91CD\u8981\u7684\u662F\uFF0C\u9700\u8981\u6DFB\u52A0\u4E24\u4E2A\u6210\u5458\u7ED3\u6784\u7684\u5B9A\u4E49\uFF08<code>ngx_http_headers_in_t</code>\uFF0C<code>ngx_http_headers_out_t</code>\uFF09\u3001\u56DE\u8C03\u51FD\u6570\u58F0\u660E\u548C\u5E38\u91CF\u5B9A\u4E49\u3002</p>`,11),q=s("\u6700\u540E\uFF0CDTrace \u811A\u672C\u53EF\u4EE5\u4ECE "),T={href:"http://nginx.org/download/trace_process_request.d",target:"_blank",rel:"noopener noreferrer"},v=s("\u8FD9\u91CC"),y=s(" \u4E0B\u8F7D\u3002"),D=t(`<p>\u4EE5\u4E0B\u793A\u4F8B\u662F\u8FD0\u884C\u6B64\u811A\u672C\u7684\u8F93\u51FA\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># dtrace -C -I ./objs -s trace_process_request.d -p 4848
dtrace: script &#39;trace_process_request.d&#39; matched 1 probe
CPU     ID                    FUNCTION:NAME
  1      4 .XAbmO.ngx_http_process_request:entry request line = GET / HTTP/1.1
request start sec = 1349162898

  0      4 .XAbmO.ngx_http_process_request:entry request line = GET /en/docs/nginx_dtrace_pid_provider.html HTTP/1.1
request start sec = 1349162899
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>\u4F7F\u7528\u7C7B\u4F3C\u7684\u6280\u672F\uFF0C\u8BFB\u8005\u5E94\u8BE5\u80FD\u591F\u8DDF\u8E2A\u5176\u4ED6 nginx \u51FD\u6570\u8C03\u7528\u3002</p><h2 id="\u76F8\u5173\u9605\u8BFB" tabindex="-1"><a class="header-anchor" href="#\u76F8\u5173\u9605\u8BFB" aria-hidden="true">#</a> \u76F8\u5173\u9605\u8BFB</h2>`,4),w={href:"http://docs.oracle.com/cd/E19253-01/817-6223/index.html",target:"_blank",rel:"noopener noreferrer"},C=s("Solaris \u52A8\u6001\u8DDF\u8E2A\u6307\u5357"),N={href:"http://dtrace.org/blogs/brendan/2011/02/09/dtrace-pid-provider/",target:"_blank",rel:"noopener noreferrer"},O=s("DTrace pid \u63D0\u4F9B\u7A0B\u5E8F\u4ECB\u7ECD"),E=n("h2",{id:"\u539F\u6587\u6863",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u539F\u6587\u6863","aria-hidden":"true"},"#"),s(" \u539F\u6587\u6863")],-1),S={href:"http://nginx.org/en/docs/nginx_dtrace_pid_provider.html",target:"_blank",rel:"noopener noreferrer"},j=s("http://nginx.org/en/docs/nginx_dtrace_pid_provider.html");function P(V,A){const a=p("OutboundLink");return c(),o(r,null,[u,n("p",null,[d,n("a",_,[k,e(a)]),g]),n("p",null,[h,n("a",b,[m,e(a)]),x]),f,n("p",null,[q,n("a",T,[v,e(a)]),y]),D,n("ul",null,[n("li",null,[n("a",w,[C,e(a)])]),n("li",null,[n("a",N,[O,e(a)])])]),E,n("p",null,[n("a",S,[j,e(a)])])],64)}var I=l(i,[["render",P]]);export{I as default};
