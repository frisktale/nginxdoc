<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.26">
    <title>使用 DTrace pid 提供程序调试 nginx | Hello VitePress</title><meta name="description" content="Just playing around.">
    <link rel="modulepreload" href="/nginxdoc/assets/app.af3e3276.js"><link rel="modulepreload" href="/nginxdoc/assets/使用DTrace_pid提供程序调试nginx.html.dd8b0331.js"><link rel="modulepreload" href="/nginxdoc/assets/plugin-vue_export-helper.5a098b48.js"><link rel="modulepreload" href="/nginxdoc/assets/使用DTrace_pid提供程序调试nginx.html.d67a72b6.js">
    <link rel="stylesheet" href="/nginxdoc/assets/style.49723153.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/nginxdoc/" class=""><!----><span class="site-name">Hello VitePress</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><!----><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">使用 DTrace pid 提供程序调试 nginx</p><ul class=""><li><!--[--><a aria-current="page" href="/nginxdoc/How-To/%E4%BD%BF%E7%94%A8DTrace_pid%E6%8F%90%E4%BE%9B%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95nginx.html#相关阅读" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="相关阅读"><!--[--><!--]--> 相关阅读 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/nginxdoc/How-To/%E4%BD%BF%E7%94%A8DTrace_pid%E6%8F%90%E4%BE%9B%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95nginx.html#原文档" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="原文档"><!--[--><!--]--> 原文档 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="使用-dtrace-pid-提供程序调试-nginx" tabindex="-1"><a class="header-anchor" href="#使用-dtrace-pid-提供程序调试-nginx" aria-hidden="true">#</a> 使用 DTrace pid 提供程序调试 nginx</h1><p>本文假设读者对 nginx 内部原理和 <a href="http://nginx.org/en/docs/nginx_dtrace_pid_provider.html#see_also" target="_blank" rel="noopener noreferrer">DTrace<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 有了一定的了解。</p><p>虽然使用了 <a href="http://nginx.org/en/docs/debugging_log.html" target="_blank" rel="noopener noreferrer">--with-debug<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 选项构建的 nginx 已经提供了大量关于请求处理的信息，但有时候更有必要详细地跟踪代码路径的特定部分，同时省略其余不必要的调试输出。DTrace pid 提供程序（在 Solaris，MacOS 上可用）是一个用于浏览用户程序内部的有用工具，因为它不需要更改任何代码，就可以帮助您完成任务。跟踪和打印 nginx 函数调用的简单 DTrace 脚本示例如下所示：</p><div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code>#<span class="token keyword">pragma</span> D option flowindent

pid<span class="token keyword">$</span>target<span class="token punctuation">:</span>nginx<span class="token punctuation">:</span><span class="token punctuation">:</span>entry <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

pid<span class="token keyword">$</span>target<span class="token punctuation">:</span>nginx<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">return</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>尽管如此，DTrace 的函数调用跟踪功能仅提供有限的有用信息。实时检查的功能参数通常更加有趣，但也更复杂一些。以下示例旨在帮助读者熟悉 DTrace 以及使用 DTrace 分析 nginx 行为的过程。</p><p>使用 DTrace 与 nginx 的常见方案之一是：附加到 nginx 的工作进程来记录请求行和请求开始时间。附加的相应函数是 <code>ngx_http_process_request()</code>，参数指向的是一个 <code>ngx_http_request_t</code> 结构的指针。使用 DTrace 脚本实现这种请求日志记录可以简单到：</p><div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code>pid<span class="token keyword">$</span>target<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span>ngx_http_process_request<span class="token punctuation">:</span>entry
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request <span class="token operator">=</span> <span class="token punctuation">(</span>ngx_http_request_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">copyin</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>ngx_http_request_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request_line <span class="token operator">=</span> <span class="token function">stringof</span><span class="token punctuation">(</span><span class="token function">copyin</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                                         <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;request line = %s\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;request start sec = %d\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>request<span class="token operator">-</span><span class="token operator">&gt;</span>start_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>需要注意的是，在上面的示例中，DTrace 需要引用 <code>ngx_http_process_request</code> 结构的一些相关信息。不幸的是，虽然可以在 DTrace 脚本中使用特定的 <code>#include</code> 指令，然后将其传递给 C 预处理器（使用 <code>-C</code> 标志），但这并不能真正起效。由于大量的交叉依赖，几乎所有的 nginx 头文件都必须包含在内。反过来，基于 <code>configure</code> 脚本设置，nginx 头将包括 PCRE、OpenSSL 和各种系统头文件。理论上，在 DTrace 脚本预处理和编译时，与特定的 nginx 构建相关的所有头文件都有可能被包含进来，实际上 DTrace 脚本很有可能由于某些头文件中的未知语法而造成无法编译。</p><p>上述问题可以通过在 DTrace 脚本中仅包含相关且必要的结构和类型定义来解决。DTrace 必须知道结构、类型和字段偏移的大小。因此，通过手动优化用于 DTrace 的结构定义，可以进一步降低依赖。</p><p>让我们使用上面的 DTrace 脚本示例，看看它需要哪些结构定义才能正常地工作。</p><p>首先应该包含由 configure 生成的 <code>objs/ngx_auto_config.h</code> 文件，因为它定义了一些影响各个方面的 <code>＃ifdef</code> 常量。之后，一些基本类型和定义（如 <code>ngx_str_t</code>，<code>ngx_table_elt_t</code>，<code>ngx_uint_t</code> 等）应放在 DTrace 脚本的开头。这些定义经常被使用但不太可能经常改变的。</p><p>那里有一个包含许多指向其他结构的指针的 ngx_http_process_request_t 结构。因为这些指针与这个脚本无关，而且因为它们具有相同的大小，所以可以用 void 指针来替换它们。但最好添加合适的 typedef，而不是更改定义：</p><div class="language-d ext-d line-numbers-mode"><pre class="language-d"><code><span class="token keyword">typedef</span> ngx_http_upstream_t     <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> ngx_http_request_body_t <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后但同样重要的是，需要添加两个成员结构的定义（<code>ngx_http_headers_in_t</code>，<code>ngx_http_headers_out_t</code>）、回调函数声明和常量定义。</p><p>最后，DTrace 脚本可以从 <a href="http://nginx.org/download/trace_process_request.d" target="_blank" rel="noopener noreferrer">这里<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 下载。</p><p>以下示例是运行此脚本的输出：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># dtrace -C -I ./objs -s trace_process_request.d -p 4848
dtrace: script &#39;trace_process_request.d&#39; matched 1 probe
CPU     ID                    FUNCTION:NAME
  1      4 .XAbmO.ngx_http_process_request:entry request line = GET / HTTP/1.1
request start sec = 1349162898

  0      4 .XAbmO.ngx_http_process_request:entry request line = GET /en/docs/nginx_dtrace_pid_provider.html HTTP/1.1
request start sec = 1349162899
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>使用类似的技术，读者应该能够跟踪其他 nginx 函数调用。</p><h2 id="相关阅读" tabindex="-1"><a class="header-anchor" href="#相关阅读" aria-hidden="true">#</a> 相关阅读</h2><ul><li><a href="http://docs.oracle.com/cd/E19253-01/817-6223/index.html" target="_blank" rel="noopener noreferrer">Solaris 动态跟踪指南<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="http://dtrace.org/blogs/brendan/2011/02/09/dtrace-pid-provider/" target="_blank" rel="noopener noreferrer">DTrace pid 提供程序介绍<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li></ul><h2 id="原文档" tabindex="-1"><a class="header-anchor" href="#原文档" aria-hidden="true">#</a> 原文档</h2><p><a href="http://nginx.org/en/docs/nginx_dtrace_pid_provider.html" target="_blank" rel="noopener noreferrer">http://nginx.org/en/docs/nginx_dtrace_pid_provider.html<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">10/19/2021, 1:50:39 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: frisktale@live.com">frisktale</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/nginxdoc/assets/app.af3e3276.js" defer></script>
  </body>
</html>
